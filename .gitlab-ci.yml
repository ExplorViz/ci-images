stages:
  - test
  - deploy:images
  - deploy:retagging

run-pre-commit:
  stage: test
  image: explorviz/pre-commit:latest
  tags:
    - exec-docker
  script:
    - pre-commit run --all-files --config pre-commit/.pre-commit-config.yaml

deploy-pre-commit-image:
  stage: deploy:images
  tags:
    - exec-docker
  only:
    - schedules
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n ${DOCKERHUB_USER}:${DOCKERHUB_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context=$CI_PROJECT_DIR/pre-commit --dockerfile=$CI_PROJECT_DIR/pre-commit/Dockerfile --destination=explorviz/pre-commit:latest

retag-pre-commit-image:
  stage: deploy:retagging
  tags:
    - exec-docker
  only:
    - schedules
  image:
    name: gcr.io/go-containerregistry/crane:debug
    entrypoint: [""]
  script:
    - crane auth login -u $DOCKERHUB_USER -p $DOCKERHUB_PASSWORD "index.docker.io"
    - crane cp explorviz/pre-commit:latest explorviz/pre-commit:$CI_COMMIT_SHORT_SHA